# 複数カレンダー管理機能開発タスク

## 概要
1ユーザーにつき複数のGoogleカレンダーの予定を通知できるようにするため、複数カレンダーを管理できる機能を追加する。
ユーザーとのコミュニケーションはすべてLINE Messaging APIを通じて行う。

## 対象機能
- 購読しているカレンダーの一覧表示
- カレンダーの追加
- カレンダーの削除

## 現在のシステム構成
- **アーキテクチャ**: AWS Lambda + DynamoDB + API Gateway
- **Google Calendar API**: OAuth2認証、現在は`primary`カレンダーのみ対応
- **LINE Messaging API**: Webhookによるメッセージ受信、Push/Reply API
- **データベース**: DynamoDB（現在は`OAuthTokensTable`のみ）

## 必要なタスク一覧

### 1. データベース設計・実装

#### 1.1 ユーザーカレンダー管理テーブル設計
- **優先度**: High
- **工数**: 2-3時間
- **内容**: 
  - ユーザーごとの購読カレンダー情報を管理するDynamoDBテーブル設計
  - テーブル名: `UserCalendarsTable`
  - 主キー: `userId` (LINE User ID)
  - ソートキー: `calendarId` (Google Calendar ID)
  - 属性: `calendarName`, `isEnabled`, `createdAt`, `updatedAt`

#### 1.2 DynamoDBテーブルのCloudFormation定義追加
- **優先度**: High  
- **工数**: 1時間
- **内容**: `template.yaml`に新しいテーブル定義を追加

#### 1.3 ユーザーカレンダーリポジトリクラス実装
- **優先度**: High
- **工数**: 2-3時間
- **内容**: 
  - `src/lib/user-calendar-repository.ts`
  - CRUD操作 (追加/削除/一覧取得/有効無効切り替え)
  - TypeScript型定義 `src/types/user-calendar-repository.d.ts`

### 2. Google Calendar API拡張

#### 2.1 カレンダーリスト取得機能追加
- **優先度**: High
- **工数**: 2時間
- **内容**:
  - `GoogleCalendarApiAdapter`に`fetchCalendarList()`メソッド追加
  - Google Calendar APIの`calendarList.list`エンドポイント利用
  - カレンダー名、ID、アクセスレベルの取得

#### 2.2 複数カレンダーからのイベント取得機能
- **優先度**: High
- **工数**: 3-4時間  
- **内容**:
  - `CalendarEventsNotifier`のリファクタリング
  - 複数カレンダーIDからの並列イベント取得
  - イベントのマージとソート処理
  - エラーハンドリング（一部カレンダーが取得失敗でも継続）

### 3. LINE Bot機能拡張

#### 3.1 カレンダー管理コマンド実装
- **優先度**: High
- **工数**: 4-5時間
- **内容**:
  - `LineWebhookUseCase`にコマンド処理を追加
  - コマンド例:
    - `カレンダー一覧`: 購読中のカレンダーリストを表示
    - `カレンダー追加`: 利用可能なカレンダーリストを表示し、追加を促す
    - `カレンダー削除 [カレンダー名]`: 指定カレンダーを購読から削除
    - `カレンダー有効 [カレンダー名]` / `カレンダー無効 [カレンダー名]`: カレンダーの有効無効切り替え

#### 3.2 対話式カレンダー追加フロー
- **優先度**: Medium
- **工数**: 3-4時間
- **内容**:
  - カレンダー追加時の対話式インターフェース
  - Postback Actionを使った選択式UI (もしくはクイックリプライ)
  - セッション管理（追加処理の途中状態管理）

#### 3.3 エラーハンドリングとユーザーフレンドリーメッセージ
- **優先度**: Medium
- **工数**: 2時間
- **内容**:
  - カレンダーアクセス権限エラーの適切な処理
  - ユーザーにとって分かりやすいエラーメッセージ
  - ヘルプコマンドの追加

### 4. 既存機能のリファクタリング

#### 4.1 カレンダーイベント通知の改修
- **優先度**: High
- **工数**: 2-3時間
- **内容**:
  - 固定の`primary`カレンダーから、ユーザーの購読カレンダーリストベースに変更
  - `CalendarEventsUseCase`の修正
  - 複数カレンダーからのイベント集約とメッセージ生成

#### 4.2 認証フローの拡張
- **優先度**: Low
- **工数**: 1-2時間  
- **内容**:
  - OAuth認証成功時に自動的にデフォルトカレンダーを購読リストに追加
  - `OAuthCallbackUseCase`の修正

### 5. テスト実装

#### 5.1 ユニットテスト追加
- **優先度**: Medium
- **工数**: 4-5時間
- **内容**:
  - `UserCalendarRepository`のテスト
  - 新しい`GoogleCalendarApiAdapter`メソッドのテスト  
  - `LineWebhookUseCase`の拡張機能テスト

#### 5.2 結合テスト
- **優先度**: Low
- **工数**: 2-3時間
- **内容**:
  - LINE Bot全体のフロー確認
  - 実際のGoogle Calendar APIとの連携テスト

### 6. デプロイメントと運用

#### 6.1 Lambda関数の権限更新
- **優先度**: High
- **工数**: 30分
- **内容**: `template.yaml`でDynamoDB新テーブルへのアクセス権限追加

#### 6.2 既存データ移行（該当する場合）
- **優先度**: Low
- **工数**: 1時間
- **内容**: 
  - 既存ユーザーに対してデフォルト（primary）カレンダーを自動で購読状態に設定
  - 移行スクリプト作成

#### 6.3 ドキュメント更新
- **優先度**: Low
- **工数**: 1時間
- **内容**: README.mdに新機能の説明追加

## 開発優先順位

### Phase 1: Core Infrastructure (High Priority)
1. データベース設計・実装 (1.1 - 1.3)
2. Google Calendar API拡張 (2.1 - 2.2) 
3. 既存機能のリファクタリング (4.1)

### Phase 2: LINE Bot機能 (High Priority)  
1. カレンダー管理コマンド実装 (3.1)
2. Lambda権限更新 (6.1)

### Phase 3: UX改善 (Medium Priority)
1. 対話式フロー (3.2)
2. エラーハンドリング (3.3)
3. テスト実装 (5.1)

### Phase 4: 運用・保守 (Low Priority)
1. 結合テスト (5.2)
2. データ移行 (6.2)
3. ドキュメント更新 (6.3)
4. 認証フロー拡張 (4.2)

## 技術的考慮事項

### セキュリティ
- カレンダーアクセス権限の適切な管理
- ユーザーデータのプライバシー保護
- LINE Webhook署名検証の継続

### パフォーマンス
- 複数カレンダーの並列取得によるレスポンス時間最適化
- DynamoDB読み書きの効率化
- Lambda関数のコールドスタート対策

### スケーラビリティ  
- ユーザー数増加に対するDynamoDB設計の考慮
- Google Calendar API Rate Limit対策
- LINE Messaging API制限への対応

## 見積もり工数
- **総工数**: 約 30-40 時間
- **最小実装（Phase 1-2）**: 約 15-20 時間
- **完全実装（Phase 1-4）**: 約 30-40 時間