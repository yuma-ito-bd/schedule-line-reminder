# 6. デプロイメントと運用

## 概要
複数カレンダー管理機能をプロダクション環境にデプロイし、安定した運用を開始するためのタスク。既存ユーザーへの影響を最小限に抑えながら、新機能を段階的に展開する。

## タスク詳細

### 6.1 Lambda関数の権限更新
- **優先度**: High
- **工数**: 30分
- **内容**: `template.yaml`でDynamoDB新テーブルへのアクセス権限追加
- **参照**: 詳細なCloudFormation定義は [1. データベース設計・実装](./tasks_01_database_design_implementation.md) を参照

### 6.2 既存データ移行（該当する場合）
- **優先度**: Low
- **工数**: 1時間
- **内容**: 
  - 既存ユーザーに対してデフォルト（primary）カレンダーを自動で購読状態に設定
  - 移行スクリプト作成

### 6.3 ドキュメント更新
- **優先度**: Low
- **工数**: 1時間
- **内容**: README.mdに新機能の説明追加

## デプロイメント詳細

### 6.2 データ移行戦略

#### 移行スクリプト
- **ファイル**: `scripts/migrate-existing-users.ts`
- **実行タイミング**: 新機能デプロイ後
- **処理内容**:
  1. OAuthTokensTable から既存ユーザーリストを取得
  2. 各ユーザーに対して primary カレンダーを UserCalendarsTable に追加
  3. エラーハンドリングとログ出力

#### 移行手順
1. **事前確認**: 既存ユーザー数とデータ整合性の確認
2. **バックアップ**: 現在のDynamoDBデータのバックアップ取得
3. **段階的実行**: 小規模なユーザーグループでテスト実行
4. **全体実行**: 全ユーザーへの移行実行
5. **検証**: 移行完了後の動作確認

### 6.3 ドキュメント整備

#### README.md 更新内容
- **新機能の概要**: 複数カレンダー管理機能の説明
- **ユーザー向け使用方法**: LINE Bot コマンドの使い方
- **開発者向け情報**: 新しいAPIとデータベース構造
- **デプロイ手順**: 環境構築とデプロイの手順
- **トラブルシューティング**: よくある問題と解決方法

#### 技術仕様書の作成
- **API仕様**: 新しいエンドポイントとデータ構造
- **データベース設計**: テーブル構造とインデックス
- **アーキテクチャ図**: システム全体の構成図

## デプロイメント戦略

### 段階的デプロイ (Blue-Green Deployment)

#### Phase 1: インフラストラクチャ
1. **新しいDynamoDBテーブル作成**
2. **Lambda関数の権限更新**
3. **環境変数の設定**

#### Phase 2: アプリケーションデプロイ
1. **新機能を含むLambda関数のデプロイ**
2. **既存機能の動作確認**
3. **新機能の動作テスト**

#### Phase 3: データ移行
1. **移行スクリプトの実行**
2. **データ整合性の確認**
3. **ユーザー動作確認**

#### Phase 4: 監視とフィードバック
1. **ログ監視の設定**
2. **エラー率の監視**
3. **ユーザーフィードバックの収集**

### ロールバック戦略

#### 緊急時の対応
1. **即座のロールバック**: 前のバージョンへの切り戻し
2. **データ復旧**: バックアップからのデータ復元
3. **ユーザー通知**: 問題発生時のユーザーへの適切な通知

## 運用・監視

### ログ監視
- **CloudWatch Logs**: Lambda関数の実行ログ
- **エラー監視**: 異常終了やAPI制限の監視
- **パフォーマンス監視**: レスポンス時間と実行時間

### アラート設定
- **エラー率**: 5%を超えたらアラート
- **API制限**: Google Calendar API制限に近づいたらアラート
- **DynamoDB**: スロットリングやエラー率の監視

### メトリクス
- **ユーザーアクティビティ**: コマンド使用頻度
- **カレンダー追加率**: 新機能の利用状況
- **通知成功率**: イベント通知の配信成功率

### 定期メンテナンス
- **データクリーンアップ**: 古いセッションデータの削除
- **パフォーマンス最適化**: DynamoDBのパーティション調整
- **セキュリティ更新**: 依存関係の定期的な更新

## セキュリティ考慮事項

### データ保護
- **暗号化**: DynamoDBの保存時暗号化
- **アクセス制御**: 最小権限の原則に基づくIAM設定
- **監査ログ**: すべてのデータアクセスのログ記録

### API セキュリティ
- **レート制限**: 悪意のあるリクエストからの保護
- **入力検証**: ユーザー入力の適切な検証
- **エラー情報**: 機密情報を含まないエラーメッセージ

## 関連ファイル
- `template.yaml` - CloudFormation テンプレート
- `scripts/migrate-existing-users.ts` - データ移行スクリプト
- `scripts/deploy.sh` - デプロイメントスクリプト
- `docs/README.md` - 更新されたドキュメント
- `docs/api-specification.md` - API仕様書
- `docs/troubleshooting.md` - トラブルシューティングガイド