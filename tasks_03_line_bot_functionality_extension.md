# 3. LINE Bot機能拡張

## 概要
複数カレンダー管理のためのLINE Botコマンド機能を実装する。ユーザーはLINE上でカレンダーの追加・削除・一覧表示・有効無効切り替えを行えるようにする。

## タスク詳細

### 3.1 カレンダー管理コマンド実装
- **優先度**: High
- **工数**: 4-5時間
- **内容**:
  - `LineWebhookUseCase`にコマンド処理を追加
  - コマンド例:
    - `カレンダー一覧`: 購読中のカレンダーリストを表示
    - `カレンダー追加`: 利用可能なカレンダーリストを表示し、追加を促す
    - `カレンダー削除 [カレンダー名]`: 指定カレンダーを購読から削除
    - `カレンダー有効 [カレンダー名]` / `カレンダー無効 [カレンダー名]`: カレンダーの有効無効切り替え

### 3.2 対話式カレンダー追加フロー
- **優先度**: Medium
- **工数**: 3-4時間
- **内容**:
  - カレンダー追加時の対話式インターフェース
  - Postback Actionを使った選択式UI (もしくはクイックリプライ)
  - セッション管理（追加処理の途中状態管理）

### 3.3 エラーハンドリングとユーザーフレンドリーメッセージ
- **優先度**: Medium
- **工数**: 2時間
- **内容**:
  - カレンダーアクセス権限エラーの適切な処理
  - ユーザーにとって分かりやすいエラーメッセージ
  - ヘルプコマンドの追加

## コマンド仕様

### 基本コマンド
- **`カレンダー一覧`** または **`カレンダー`**
  - 現在購読中のカレンダー一覧を表示
  - 各カレンダーの有効/無効状態も表示

- **`カレンダー追加`**
  - Google Calendarから利用可能なカレンダーリストを取得
  - ユーザーに選択肢を提示（Postback Action使用）

- **`カレンダー削除 [カレンダー名]`**
  - 指定されたカレンダーを購読から削除
  - 確認メッセージを表示

- **`カレンダー有効 [カレンダー名]`**
  - 指定カレンダーの通知を有効化

- **`カレンダー無効 [カレンダー名]`**
  - 指定カレンダーの通知を無効化

- **`ヘルプ`** または **`help`**
  - 使用可能なコマンド一覧を表示

## 技術的考慮事項

### ユーザーインターフェース
- **LINE Messaging API**: Push/Reply API の活用
- **Rich Menu**: 頻繁に使用する機能へのクイックアクセス
- **Postback Action**: 選択式インターフェースでのユーザビリティ向上
- **Quick Reply**: 簡単な選択肢の提供

### セッション管理
- **状態管理**: 対話途中の状態をDynamoDBまたはメモリで管理
- **タイムアウト**: セッション有効期限の設定
- **エラー復旧**: セッション途中でエラーが発生した場合の処理

### エラーハンドリング
- **権限エラー**: カレンダーアクセス権限がない場合の適切な案内
- **API制限**: Google Calendar API制限に達した場合の処理
- **ネットワークエラー**: 一時的な通信エラーの適切なハンドリング

## 関連ファイル
- `src/use-cases/line-webhook-use-case.ts` - Webhook処理ロジック
- `src/adapters/line-messaging-api-adapter.ts` - LINE API アダプター
- `src/lib/session-manager.ts` - セッション管理（新規作成）
- `src/types/line-bot.d.ts` - 型定義